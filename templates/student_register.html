{% extends "base.html" %}

{% block title %}Student Registration - Face Recognition Attendance System{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-primary text-white text-center py-8">
                <h2 class="text-3xl md:text-4xl font-bold mb-2">
                    <i class="fas fa-user-graduate mr-3"></i>
                    Student Registration
                </h2>
                <p class="text-blue-100 text-lg">Join our smart attendance system</p>
            </div>

            <div class="p-8">
                <form method="POST" enctype="multipart/form-data" id="studentForm" class="space-y-8">
                    <!-- Personal Information -->
                    <div>
                        <h3 class="text-2xl font-bold text-primary mb-6 flex items-center">
                            <i class="fas fa-user mr-3"></i>Personal Information
                        </h3>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="roll_number" class="block text-sm font-semibold text-gray-700 mb-2">Roll Number *</label>
                                <input type="text" id="roll_number" name="roll_number" required
                                       placeholder="e.g., 2024001"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 text-lg">
                            </div>

                            <div>
                                <label for="name" class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                                <input type="text" id="name" name="name" required
                                       placeholder="Enter your full name"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 text-lg">
                            </div>

                            <div>
                                <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">Email Address *</label>
                                <input type="email" id="email" name="email" required
                                       placeholder="your.email@example.com"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 text-lg">
                            </div>

                            <div>
                                <label for="phone" class="block text-sm font-semibold text-gray-700 mb-2">Phone Number *</label>
                                <input type="tel" id="phone" name="phone" required
                                       placeholder="+1234567890"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 text-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Academic Information -->
                    <div>
                        <h3 class="text-2xl font-bold text-primary mb-6 flex items-center">
                            <i class="fas fa-graduation-cap mr-3"></i>Academic Information
                        </h3>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="course" class="block text-sm font-semibold text-gray-700 mb-2">Course *</label>
                                <select id="course" name="course" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 text-lg">
                                    <option value="">Select Course</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="Information Technology">Information Technology</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Mechanical">Mechanical</option>
                                    <option value="Civil">Civil</option>
                                    <option value="Electrical">Electrical</option>
                                </select>
                            </div>

                            <div>
                                <label for="year" class="block text-sm font-semibold text-gray-700 mb-2">Academic Year *</label>
                                <select id="year" name="year" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 text-lg">
                                    <option value="">Select Year</option>
                                    <option value="1st Year">1st Year</option>
                                    <option value="2nd Year">2nd Year</option>
                                    <option value="3rd Year">3rd Year</option>
                                    <option value="4th Year">4th Year</option>
                                </select>
                            </div>

                            <div>
                                <label for="semester" class="block text-sm font-semibold text-gray-700 mb-2">Semester *</label>
                                <select id="semester" name="semester" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 text-lg">
                                    <option value="">Select Semester</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                    <option value="3">Semester 3</option>
                                    <option value="4">Semester 4</option>
                                    <option value="5">Semester 5</option>
                                    <option value="6">Semester 6</option>
                                    <option value="7">Semester 7</option>
                                    <option value="8">Semester 8</option>
                                </select>
                            </div>

                            <div>
                                <label for="subject" class="block text-sm font-semibold text-gray-700 mb-2">Subject *</label>
                                <select id="subject" name="subject" required disabled
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 text-lg disabled:bg-gray-100 disabled:cursor-not-allowed">
                                    <option value="">Select Subject</option>
                                </select>
                                <p class="mt-1 text-sm text-gray-500">Please select a semester first</p>
                            </div>
                        </div>
                    </div>

                    <!-- Photo Upload -->
                    <div>
                        <h3 class="text-2xl font-bold text-primary mb-6 flex items-center">
                            <i class="fas fa-camera mr-3"></i>Face Recognition Setup
                        </h3>

                        <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6 rounded-r-lg">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-camera text-green-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-green-700">
                                        <strong>Live Camera Registration:</strong> Capture your photo using the camera for best face recognition accuracy.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Camera Capture Section -->
                        <div class="bg-gray-50 p-6 rounded-lg mb-6 border-2 border-dashed border-gray-300">
                            <div class="text-center">
                                <video id="video" width="400" height="300" autoplay class="mx-auto border rounded-lg mb-4 shadow-lg" style="display: none;"></video>
                                <canvas id="canvas" width="400" height="300" class="mx-auto border rounded-lg mb-4 shadow-lg" style="display: none;"></canvas>
                                <div id="photo-preview" class="mx-auto mb-4" style="display: none;">
                                    <img id="captured-photo" class="mx-auto border rounded-lg shadow-lg" style="max-width: 400px; max-height: 300px;">
                                </div>

                                <div id="camera-placeholder" class="text-gray-500 py-12">
                                    <i class="fas fa-camera text-6xl mb-4"></i>
                                    <p class="text-lg">Click "Start Camera" to begin photo capture</p>
                                </div>
                            </div>

                            <div class="text-center space-x-4 mt-4">
                                <button type="button" id="start-camera" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200">
                                    <i class="fas fa-video mr-2"></i>Start Camera
                                </button>
                                <button type="button" id="capture-photo" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200" style="display: none;">
                                    <i class="fas fa-camera mr-2"></i>Capture Photo
                                </button>
                                <button type="button" id="retake-photo" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200" style="display: none;">
                                    <i class="fas fa-redo mr-2"></i>Retake Photo
                                </button>
                            </div>

                            <div class="mt-6 text-sm text-gray-600 bg-white p-4 rounded-lg">
                                <h4 class="font-semibold mb-2"><i class="fas fa-info-circle text-blue-500 mr-2"></i>Photo Guidelines:</h4>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>Look directly at the camera</li>
                                    <li>Ensure good lighting on your face</li>
                                    <li>Keep face centered in frame</li>
                                    <li>Remove glasses if possible</li>
                                    <li>Maintain neutral expression</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Hidden input for photo data -->
                        <input type="hidden" id="photo-data" name="photo_data">

                        
                    </div>

                    <!-- Submit Button -->
                    <div class="flex flex-col sm:flex-row gap-4 justify-center pt-6">
                        <button type="submit" class="bg-primary hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200">
                            <i class="fas fa-user-plus mr-2"></i>
                            Register Student
                        </button>
                        <a href="{{ url_for('index') }}" class="border-2 border-gray-300 text-gray-700 hover:bg-gray-50 font-semibold py-4 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200 text-center">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back to Home
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let video, canvas, context, stream;
let photoTaken = false;

// Initialize camera functionality
document.addEventListener('DOMContentLoaded', function() {
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    context = canvas.getContext('2d');

    // Camera controls
    document.getElementById('start-camera').addEventListener('click', startCamera);
    document.getElementById('capture-photo').addEventListener('click', capturePhoto);
    document.getElementById('retake-photo').addEventListener('click', retakePhoto);

    // Semester and subject selection
    document.getElementById('semester').addEventListener('change', handleSemesterChange);
});

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: 400,
                height: 300,
                facingMode: 'user'
            }
        });

        video.srcObject = stream;
        video.style.display = 'block';
        document.getElementById('camera-placeholder').style.display = 'none';
        document.getElementById('start-camera').style.display = 'none';
        document.getElementById('capture-photo').style.display = 'inline-block';

    } catch (err) {
        console.error('Error accessing camera:', err);
        alert('Unable to access camera. Please use file upload instead.');
    }
}

function capturePhoto() {
    // Draw video frame to canvas
    context.drawImage(video, 0, 0, 400, 300);

    // Convert to base64
    const photoData = canvas.toDataURL('image/jpeg', 0.8);

    // Display captured photo
    document.getElementById('captured-photo').src = photoData;
    document.getElementById('photo-preview').style.display = 'block';

    // Hide video and show retake button
    video.style.display = 'none';
    document.getElementById('capture-photo').style.display = 'none';
    document.getElementById('retake-photo').style.display = 'inline-block';

    // Store photo data
    document.getElementById('photo-data').value = photoData;
    photoTaken = true;

    // Stop camera stream
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
}

function retakePhoto() {
    // Reset UI
    document.getElementById('photo-preview').style.display = 'none';
    document.getElementById('retake-photo').style.display = 'none';
    document.getElementById('start-camera').style.display = 'inline-block';
    document.getElementById('camera-placeholder').style.display = 'block';

    // Clear photo data
    document.getElementById('photo-data').value = '';
    photoTaken = false;
}

function handleSemesterChange() {
    const semester = document.getElementById('semester').value;
    const subjectSelect = document.getElementById('subject');
    
    // Clear previous options
    subjectSelect.innerHTML = '<option value="">Select Subject</option>';
    
    if (semester) {
        // Enable subject dropdown
        subjectSelect.disabled = false;
        subjectSelect.parentElement.querySelector('p').textContent = 'Select your subject';
        
        // Define subjects for each semester
        const subjects = {
            '1': ['Mathematics I', 'Physics', 'Chemistry', 'Engineering Drawing', 'Communication Skills'],
            '2': ['Mathematics II', 'Environmental Science', 'Programming Fundamentals', 'Electronic Devices', 'Workshop Technology'],
            '3': ['Mathematics III', 'Data Structures', 'Digital Electronics', 'Computer Organization', 'Object Oriented Programming'],
            '4': ['Mathematics IV', 'Database Management', 'Operating Systems', 'Computer Networks', 'Web Technologies'],
            '5': ['Software Engineering', 'Compiler Design', 'Artificial Intelligence', 'Mobile Computing', 'Project Management'],
            '6': ['Machine Learning', 'Cloud Computing', 'Cyber Security', 'Advanced Database', 'Human Computer Interaction'],
            '7': ['Big Data Analytics', 'Internet of Things', 'Blockchain Technology', 'Advanced Networks', 'Industry Project I'],
            '8': ['Final Year Project', 'Internship', 'Entrepreneurship', 'Professional Ethics', 'Industry Project II']
        };
        
        // Add subjects for selected semester
        if (subjects[semester]) {
            subjects[semester].forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
        }
    } else {
        // Disable subject dropdown
        subjectSelect.disabled = true;
        subjectSelect.parentElement.querySelector('p').textContent = 'Please select a semester first';
    }
}

// Form validation
document.getElementById('studentForm').addEventListener('submit', function(e) {
    const requiredFields = ['roll_number', 'name', 'email', 'phone', 'course', 'year', 'semester', 'subject'];
    let isValid = true;

    // Check required text fields
    requiredFields.forEach(field => {
        const input = document.getElementById(field);
        if (!input.value.trim()) {
            input.classList.add('border-red-500', 'ring-red-500');
            input.classList.remove('border-gray-300');
            isValid = false;
        } else {
            input.classList.remove('border-red-500', 'ring-red-500');
            input.classList.add('border-gray-300');
        }
    });

    // Check photo requirement (only camera capture now)
    const photoData = document.getElementById('photo-data').value;

    if (!photoData) {
        alert('Please capture a photo using the camera.');
        isValid = false;
    }

    if (!isValid) {
        e.preventDefault();
        alert('Please fill in all required fields and capture a photo.');
    }
});
</script>
{% endblock %}
